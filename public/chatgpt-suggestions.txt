const $modal = document.querySelector("dialog");
const $form = document.querySelector("form");

const $newArticleButton = document.getElementById("new-article");
const $articleSection = document.getElementById("article-section"); // Parent container of articles

const $inputTitle = document.getElementById("input-title");
const $inputContent = document.getElementById("input-content");

// Open modal for new article
$newArticleButton.onclick = () => {
    $modal.showModal();
    $inputTitle.value = "";
    $inputContent.value = "";
};

// Closes modal when user clicks outside of dialog bounds
$modal.addEventListener("click", e => {
    const dialogDimensions = $modal.getBoundingClientRect();
    if (
        e.clientX < dialogDimensions.left ||
        e.clientX > dialogDimensions.right ||
        e.clientY < dialogDimensions.top ||
        e.clientY > dialogDimensions.bottom
    ) {
        $modal.close();
    }
});

// Event delegation for edit buttons
$articleSection.addEventListener("click", function (e) {
    if (e.target.closest(".edit")) { // Check if the clicked element is inside an "edit" button
        const article = e.target.closest("article"); // Find the closest article to the button
        const title = article.querySelector(".article-title h4").textContent;
        const content = article.querySelector(".article-content p").textContent;

        // Populate the modal with article's data
        $inputTitle.value = title;
        $inputContent.value = content;

        // Show the modal
        $modal.showModal();
    }
});

// Handle form submission for new article or saving
$form.addEventListener("submit", function (e) {
    e.preventDefault();

    // If the title and content are not empty, add a new article or save the edit
    if ($inputTitle.value !== "" && $inputContent.value !== "") {
        const newArticle = `
            <article>
                <div class="article-title"><h4>${$inputTitle.value}</h4></div>
                <div class="article-content"><p>${$inputContent.value}</p></div>
                <div class="buttons">
                    <button class="delete"><i class="fa-solid fa-delete-left fa-lg fa-fw"></i></button>
                    <button class="edit"><i class="fa-solid fa-pen-to-square fa-lg fa-fw"></i></button>
                </div>
            </article>
        `;

        if ($inputTitle.value && $inputContent.value) {
            // Check if we're editing or adding a new article
            const isEditing = $form.dataset.isEditing;
            
            if (isEditing) {
                // If editing, replace the article's content with the updated content
                const articleToEdit = document.querySelector(`[data-article-id="${$form.dataset.articleId}"]`);
                articleToEdit.querySelector(".article-title h4").textContent = $inputTitle.value;
                articleToEdit.querySelector(".article-content p").textContent = $inputContent.value;

                // Remove data attributes after editing
                delete $form.dataset.isEditing;
                delete $form.dataset.articleId;
            } else {
                // If adding, insert a new article
                $articleSection.insertAdjacentHTML("afterbegin", newArticle);
            }
        }
    }

    // Reset form
    $inputTitle.value = "";
    $inputContent.value = "";

    // Close modal
    $modal.close();
});
